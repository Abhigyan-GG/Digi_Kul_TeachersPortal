{% extends 'base.html' %}
{% block title %}Register • Digi Kul{% endblock %}
{% block content %}
<div class="register-container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); position: relative; overflow: hidden; margin: -2rem -1rem; padding: 2rem 1rem;">
  <!-- Background Elements -->
  <div class="bg-elements" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1;">
    <div class="bg-shape" style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(255,255,255,0.08); border-radius: 50%; animation: float 7s ease-in-out infinite;"></div>
    <div class="bg-shape" style="position: absolute; bottom: -150px; left: -150px; width: 400px; height: 400px; background: rgba(255,255,255,0.05); border-radius: 50%; animation: float 9s ease-in-out infinite reverse;"></div>
    <div class="bg-shape" style="position: absolute; top: 30%; right: 20%; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; animation: float 5s ease-in-out infinite;"></div>
  </div>
  
  <div class="card" style="max-width: 550px; margin: 2rem; position: relative; z-index: 2; backdrop-filter: blur(10px); background: rgba(255,255,255,0.95); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 25px 50px rgba(0,0,0,0.15);">
    <div class="card-header" style="text-align: center; padding: 2rem 2rem 1rem 2rem;">
      <div class="logo-container" style="margin-bottom: 1rem;">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--secondary), var(--primary)); border-radius: 20px; margin: 0 auto; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(118, 75, 162, 0.3);">
          <span style="font-size: 2.5rem; color: white;">🚀</span>
        </div>
      </div>
      <h2 class="card-title" style="margin-bottom: 0.5rem; color: var(--gray-900);">Join Digi Kul</h2>
      <p class="card-subtitle" style="color: var(--gray-600);">Create your admin account to get started</p>
    </div>
    <div class="card-body" style="padding: 1rem 2rem 2rem 2rem;">
      <form id="registerForm" onsubmit="registerUser(event)">
        <div class="form-group">
          <label for="reg_user_type" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
            <span style="font-size: 1.2rem;">👑</span>
            Account Type
          </label>
          <select id="reg_user_type" required style="padding: 1rem; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: var(--gray-50); width: 100%;">
            <option value="admin">🔑 Admin Account</option>
          </select>
        </div>
        <div class="form-group">
          <label for="name" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
            <span style="font-size: 1.2rem;">👤</span>
            Full Name
          </label>
          <input type="text" id="name" placeholder="Enter your full name" required style="padding: 1rem; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: var(--gray-50);" />
        </div>
        <div class="form-group">
          <label for="email" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
            <span style="font-size: 1.2rem;">📧</span>
            Email Address
          </label>
          <input type="email" id="email" placeholder="Enter your email address" required style="padding: 1rem; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: var(--gray-50);" />
        </div>
        <div id="institutionField" class="form-group">
          <label for="institution" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
            <span style="font-size: 1.2rem;">🏫</span>
            Institution
          </label>
          <input type="text" id="institution" placeholder="Enter your institution name" style="padding: 1rem; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: var(--gray-50);" />
        </div>
        <div id="teacherFields" class="form-group" style="display: none;">
          <label for="subject" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
            <span style="font-size: 1.2rem;">📚</span>
            Subject (Teachers)
          </label>
          <input type="text" id="subject" placeholder="Enter your subject" style="padding: 1rem; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: var(--gray-50);" />
        </div>
        <div class="form-group">
          <label for="password" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">
            <span style="font-size: 1.2rem;">🔒</span>
            Password
          </label>
          <div style="position: relative;">
            <input type="password" id="password" placeholder="Create a strong password" required style="padding: 1rem; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: var(--gray-50); width: 100%;" />
            <button type="button" onclick="togglePassword()" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--gray-500);">👁️</button>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray-500);">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
              <span id="length-check" style="color: var(--gray-400);">⚪</span>
              <span>At least 8 characters</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span id="strength-check" style="color: var(--gray-400);">⚪</span>
              <span>Mix of letters, numbers, and symbols</span>
            </div>
          </div>
        </div>
        <div class="form-group" style="margin-top: 1.5rem;">
          <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px; background: linear-gradient(135deg, var(--secondary), var(--primary)); box-shadow: 0 8px 25px rgba(118, 75, 162, 0.3); transition: all 0.3s ease;">
            <span style="margin-right: 0.5rem;">✨</span>
            Create Account
          </button>
        </div>
      </form>
      <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
        <p style="color: var(--gray-600); margin-bottom: 0.5rem;">Already have an account?</p>
        <a href="/login" style="color: var(--primary); text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; background: rgba(102, 126, 234, 0.1); transition: all 0.3s ease;">
          <span>🔑</span>
          Sign In
        </a>
      </div>
      <div id="regError" class="alert error" style="display:none; margin-top: 1rem; border-radius: 12px; padding: 1rem;"></div>
      <div id="regSuccess" class="alert success" style="display:none; margin-top: 1rem; border-radius: 12px; padding: 1rem;"></div>
    </div>
  </div>
</div>

<style>
@keyframes float {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(5deg); }
}

.register-container input:focus,
.register-container select:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
  background: var(--white);
}

.register-container .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(118, 75, 162, 0.4);
}

.bg-elements .bg-shape {
  animation-duration: 7s;
}

.bg-elements .bg-shape:nth-child(2) {
  animation-duration: 9s;
  animation-delay: -3s;
}

.bg-elements .bg-shape:nth-child(3) {
  animation-duration: 5s;
  animation-delay: -1s;
}
</style>

<script>
function togglePassword() {
  const passwordInput = document.getElementById('password');
  const toggleButton = passwordInput.nextElementSibling;
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleButton.textContent = '🙈';
  } else {
    passwordInput.type = 'password';
    toggleButton.textContent = '👁️';
  }
}

function checkPasswordStrength() {
  const password = document.getElementById('password').value;
  const lengthCheck = document.getElementById('length-check');
  const strengthCheck = document.getElementById('strength-check');
  
  // Length check
  if (password.length >= 8) {
    lengthCheck.textContent = '✅';
    lengthCheck.style.color = 'var(--success)';
  } else {
    lengthCheck.textContent = '⚪';
    lengthCheck.style.color = 'var(--gray-400)';
  }
  
  // Strength check
  const hasLetter = /[a-zA-Z]/.test(password);
  const hasNumber = /\d/.test(password);
  const hasSymbol = /[!@#$%^&*(),.?":{}|<>]/.test(password);
  
  if (hasLetter && hasNumber && hasSymbol) {
    strengthCheck.textContent = '✅';
    strengthCheck.style.color = 'var(--success)';
  } else if (hasLetter && (hasNumber || hasSymbol)) {
    strengthCheck.textContent = '⚠️';
    strengthCheck.style.color = 'var(--warning)';
  } else {
    strengthCheck.textContent = '⚪';
    strengthCheck.style.color = 'var(--gray-400)';
  }
}

const typeSelect = document.getElementById('reg_user_type');
const teacherFields = document.getElementById('teacherFields');
const institutionField = document.getElementById('institutionField');

typeSelect.addEventListener('change', () => {
  const userType = typeSelect.value;
  teacherFields.style.display = userType === 'teacher' ? 'block' : 'none';
  institutionField.style.display = userType === 'admin' ? 'none' : 'block';
});

// Add password strength checking
document.getElementById('password').addEventListener('input', checkPasswordStrength);

async function registerUser(e){
  e.preventDefault();
  const user_type = document.getElementById('reg_user_type').value;
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const submitButton = document.querySelector('button[type="submit"]');

  const errorBox = document.getElementById('regError');
  const successBox = document.getElementById('regSuccess');
  errorBox.style.display = 'none';
  successBox.style.display = 'none';

  // Add loading state
  const originalText = submitButton.innerHTML;
  submitButton.innerHTML = '<span style="margin-right: 0.5rem;">⏳</span>Creating Account...';
  submitButton.disabled = true;

  try {
    const endpoint = '/api/register/admin';
    const payload = { name, email, password };

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok || !data.success){
      errorBox.textContent = data.error || 'Registration failed';
      errorBox.style.display = 'block';
      return;
    }
    
    // Success animation
    submitButton.innerHTML = '<span style="margin-right: 0.5rem;">✅</span>Account Created!';
    submitButton.style.background = 'linear-gradient(135deg, var(--success), #059669)';
    
    successBox.textContent = 'Registration successful! Redirecting to login...';
    successBox.style.display = 'block';
    
    setTimeout(() => {
      window.location.href = '/login';
    }, 2000);
    
  } catch (err){
    errorBox.textContent = 'Network error';
    errorBox.style.display = 'block';
  } finally {
    // Reset button state
    setTimeout(() => {
      submitButton.innerHTML = originalText;
      submitButton.disabled = false;
      submitButton.style.background = 'linear-gradient(135deg, var(--secondary), var(--primary))';
    }, 3000);
  }
}
</script>
{% endblock %}



