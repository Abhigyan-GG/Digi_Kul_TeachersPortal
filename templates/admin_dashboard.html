{% extends 'base.html' %}
{% block title %}Admin Dashboard • Digi Kul{% endblock %}
{% block header_title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="tabs">
    <button class="tab active" onclick="switchTab('cohorts', event)">🏫 Manage Cohorts</button>
    <button class="tab" onclick="switchTab('teachers', event)">👨‍🏫 Teachers</button>
    <button class="tab" onclick="switchTab('students', event)">👨‍🎓 Students</button>
    <button class="tab" onclick="switchTab('create', event)">➕ Create Cohort</button>
</div>

<!-- Cohorts Tab -->
<div id="cohorts" class="tab-content active">
    <div class="card-header">
        <h2 class="card-title">All Cohorts</h2>
        <p class="card-subtitle">Manage cohorts, students, and lectures</p>
    </div>
    <div id="cohorts-list"></div>
    <div id="cohort-manage" style="display:none; margin-top:1rem;" class="cohort-card">
        <h3 id="manage-cohort-title">Manage Cohort</h3>
        <div id="cohort-code-display" style="display:none; background: #e3f2fd; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #2196f3;">
            <h4 style="margin: 0 0 0.5rem 0; color: #1976d2;">📋 Cohort Code for Students</h4>
            <p style="margin: 0; font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: bold; color: #1976d2;">
                <span id="display-cohort-code"></span>
                <button class="btn-copy" onclick="copyCohortCode(document.getElementById('display-cohort-code').textContent, 'display-cohort-code')" title="Copy to clipboard">📋</button>
            </p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #666;">Share this code with students so they can join the cohort</p>
        </div>
        <div>
            <h4>Students in Cohort</h4>
            <div id="cohort-students"></div>
        </div>
        <div style="margin-top:1rem;">
            <h4>Add Student</h4>
            <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
                <select id="add-student-select" style="flex:1; padding:.6rem; border:1px solid #e9ecef; border-radius:6px;">
                    <option value="">Select a student...</option>
                </select>
                <span class="muted">or</span>
                <input id="add-student-email" type="email" placeholder="student@example.com" style="flex:1; padding:.6rem; border:1px solid #e9ecef; border-radius:6px;">
                <button class="btn" id="add-student-btn">Add</button>
            </div>
        </div>
    </div>
    <div id="cohortLectures" style="display:none; margin-top:1rem;" class="cohort-card">
        <h4>Lectures in Cohort</h4>
        <div id="cohort-lectures-list"></div>
    </div>
    <div id="cohortPolls" style="display:none; margin-top:1rem;" class="cohort-card">
        <h4>Polls in Cohort</h4>
        <div style="margin-bottom: 1rem;">
            <button class="btn" onclick="showCreateCohortPollModal()">📊 Create Poll</button>
        </div>
        <div id="cohort-polls-list"></div>
    </div>
    
    <!-- Poll Creation Modal -->
    <div id="pollModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Poll</h3>
                <span class="close" onclick="closePollModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="pollQuestion">Poll Question</label>
                    <textarea id="pollQuestion" placeholder="Enter your poll question..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Poll Options</label>
                    <div id="pollOptions">
                        <div class="option-row">
                            <input type="text" placeholder="Option 1" class="poll-option-input">
                            <button class="btn-remove" onclick="removePollOption(this)">×</button>
                        </div>
                        <div class="option-row">
                            <input type="text" placeholder="Option 2" class="poll-option-input">
                            <button class="btn-remove" onclick="removePollOption(this)">×</button>
                        </div>
                    </div>
                    <button class="btn-add" onclick="addPollOption()">+ Add Option</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="createCohortPollFromModal()">Create Poll</button>
                <button class="btn btn-secondary" onclick="closePollModal()">Cancel</button>
            </div>
        </div>
    </div>
    <input type="hidden" id="current-cohort-id" value="">
    <input type="hidden" id="current-cohort-name" value="">
    <input type="hidden" id="current-cohort-code" value="">
    <input type="hidden" id="current-cohort-teacher" value="">
    <input type="hidden" id="current-cohort-subject" value="">
    <input type="hidden" id="current-cohort-created-at" value="">
    <input type="hidden" id="current-cohort-student-count" value="">
    <input type="hidden" id="current-cohort-description" value="">
</div>

<!-- Teachers Tab -->
<div id="teachers" class="tab-content">
    <div class="card-header">
        <h2 class="card-title">All Teachers</h2>
        <p class="card-subtitle">Manage teacher accounts and permissions</p>
    </div>
    <div style="margin-bottom: 1rem;">
        <button class="btn" onclick="showCreateTeacherModal()">➕ Add Teacher</button>
    </div>
    <div id="teachers-list"></div>
    
    <!-- Create Teacher Modal -->
    <div id="createTeacherModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Teacher</h3>
                <span class="close" onclick="closeCreateTeacherModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="create-teacher-form">
                    <div class="form-group">
                        <label for="teacher-name">Name</label>
                        <input type="text" id="teacher-name" required>
                    </div>
                    <div class="form-group">
                        <label for="teacher-email">Email</label>
                        <input type="email" id="teacher-email" required>
                    </div>
                    <div class="form-group">
                        <label for="teacher-institution">Institution</label>
                        <input type="text" id="teacher-institution" required>
                    </div>
                    <div class="form-group">
                        <label for="teacher-subject">Subject</label>
                        <input type="text" id="teacher-subject" required>
                    </div>
                    <div class="form-group">
                        <label for="teacher-password">Password</label>
                        <input type="password" id="teacher-password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="createTeacher()">Create Teacher</button>
                <button class="btn btn-secondary" onclick="closeCreateTeacherModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Students Tab -->
<div id="students" class="tab-content">
    <div class="card-header">
        <h2 class="card-title">All Students</h2>
        <p class="card-subtitle">Manage student accounts and enrollments</p>
    </div>
    <div style="margin-bottom: 1rem;">
        <button class="btn" onclick="showCreateStudentModal()">➕ Add Student</button>
    </div>
    <div id="students-list"></div>
    
    <!-- Create Student Modal -->
    <div id="createStudentModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Student</h3>
                <span class="close" onclick="closeCreateStudentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="create-student-form">
                    <div class="form-group">
                        <label for="student-name">Name</label>
                        <input type="text" id="student-name" required>
                    </div>
                    <div class="form-group">
                        <label for="student-email">Email</label>
                        <input type="email" id="student-email" required>
                    </div>
                    <div class="form-group">
                        <label for="student-institution">Institution</label>
                        <input type="text" id="student-institution" required>
                    </div>
                    <div class="form-group">
                        <label for="student-password">Password</label>
                        <input type="password" id="student-password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="createStudent()">Create Student</button>
                <button class="btn btn-secondary" onclick="closeCreateStudentModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Cohort Tab -->
<div id="create" class="tab-content">
    <div class="card-header">
        <h2 class="card-title">Create New Cohort</h2>
        <p class="card-subtitle">Set up a new cohort with teacher and subject details</p>
    </div>
    <form id="cohort-form">
        <div class="form-group">
            <label for="cohort-name">Cohort Name</label>
            <input type="text" id="cohort-name" name="name" required>
        </div>
        <div class="form-group">
            <label for="cohort-description">Description</label>
            <textarea id="cohort-description" name="description" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label for="cohort-subject">Subject</label>
            <input type="text" id="cohort-subject" name="subject" required>
        </div>
        <div class="form-group">
            <label for="cohort-teacher">Assign Teacher</label>
            <select id="cohort-teacher" name="teacher_id" required>
                <option value="">Select a teacher...</option>
            </select>
        </div>
        <button type="submit" class="btn">Create Cohort</button>
    </form>
</div>

<div id="alert" class="alert"></div>

<style>
.tabs {
    display: flex;
    margin-bottom: 2rem;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.tab {
    flex: 1;
    padding: 1rem;
    background: #f8f9fa;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.tab.active {
    background: #667eea;
    color: white;
}

.tab-content {
    display: none;
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.tab-content.active {
    display: block;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
    color: #333;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
}

.btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.3s ease;
    margin-right: 10px;
    margin-bottom: 10px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.btn-danger {
    background: linear-gradient(45deg, #dc3545, #e83e8c);
}

.cohort-card, .user-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.cohort-card h3, .user-card h3 {
    color: #333;
    margin-bottom: 0.5rem;
}

.cohort-card p, .user-card p {
    color: #666;
    margin-bottom: 1rem;
}

.cohort-actions, .user-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: none;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
}

.stat-card h3 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.cohort-code-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    border: 1px solid #e9ecef;
}

.cohort-code {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #667eea;
    font-size: 1.1rem;
    letter-spacing: 1px;
}

.btn-copy {
    background: #28a745;
    color: white;
    border: none;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 0.5rem;
    font-size: 0.9rem;
    transition: background-color 0.3s ease;
}

.btn-copy:hover {
    background: #218838;
}

.btn-copy.copied {
    background: #17a2b8;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: #333;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}

.option-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    align-items: center;
}

.option-row input {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.btn-remove {
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-add {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 0.5rem;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

@media (max-width: 768px) {
    .tabs {
        flex-direction: column;
    }
    
    .cohort-actions, .user-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        margin-right: 0;
    }
}
</style>

<script>
function switchTab(tabName, event) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked tab
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Load content based on tab
    if (tabName === 'cohorts') {
        loadCohorts();
    } else if (tabName === 'teachers') {
        loadTeachers();
    } else if (tabName === 'students') {
        loadStudents();
    } else if (tabName === 'create') {
        loadTeachersForSelect();
    }
}

async function loadCohorts() {
    try {
        const res = await fetch('/api/admin/cohorts', { credentials: 'same-origin' });
        const data = await res.json();
        const container = document.getElementById('cohorts-list');
        
        if (!data.success) {
            container.innerHTML = '<p>Failed to load cohorts</p>';
            return;
        }
        
        if (data.cohorts.length === 0) {
            container.innerHTML = '<p>No cohorts found. Create your first cohort!</p>';
            return;
        }
        
                container.innerHTML = data.cohorts.map(cohort => `
            <div class="cohort-card">
                <h3>${cohort.name}</h3>
                <p>${cohort.description || 'No description'}</p>
                <p><strong>Subject:</strong> ${cohort.subject}</p>
                <p><strong>Teacher:</strong> ${cohort.teacher_name || 'Unassigned'}</p>
                <p><strong>Students:</strong> ${cohort.student_count || 0}</p>
                <div class="cohort-code-section">
                    <p><strong>Cohort Code:</strong> <span class="cohort-code" id="code-${cohort.id}">${cohort.code}</span>
                    <button class="btn-copy" onclick="copyCohortCode('${cohort.code}', 'code-${cohort.id}')" title="Copy to clipboard">📋</button></p>
                </div>
                <div class="cohort-actions">
                            <button class="btn" onclick="manageCohort('${cohort.id}', '${cohort.name.replace(/'/g, "\'")}')">Manage Students</button>
                            <button class="btn" onclick="viewCohortLectures('${cohort.id}', '${cohort.name.replace(/'/g, "\'")}')">View Lectures</button>
                            <button class="btn" onclick="viewCohortPolls('${cohort.id}', '${cohort.name.replace(/'/g, "\'")}')">📊 Polls</button>
                    <button class="btn btn-danger" onclick="deleteCohort('${cohort.id}')">Delete</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        showAlert('Failed to load cohorts: ' + error.message, 'error');
    }
}

async function loadTeachers() {
    try {
        const res = await fetch('/api/admin/teachers', { credentials: 'same-origin' });
        const data = await res.json();
        const container = document.getElementById('teachers-list');
        
        if (!data.success) {
            container.innerHTML = '<p>Failed to load teachers</p>';
            return;
        }
        
        if (data.teachers.length === 0) {
            container.innerHTML = '<p>No teachers found.</p>';
            return;
        }
        
        container.innerHTML = data.teachers.map(teacher => `
            <div class="user-card">
                <h3>${teacher.name}</h3>
                <p><strong>Email:</strong> ${teacher.email}</p>
                <p><strong>Institution:</strong> ${teacher.institution}</p>
                <p><strong>Subject:</strong> ${teacher.subject}</p>
                <p><strong>Cohorts:</strong> ${teacher.cohort_count || 0}</p>
            </div>
        `).join('');
    } catch (error) {
        showAlert('Failed to load teachers: ' + error.message, 'error');
    }
}

async function loadStudents() {
    try {
        const res = await fetch('/api/admin/students', { credentials: 'same-origin' });
        const data = await res.json();
        const container = document.getElementById('students-list');
        
        if (!data.success) {
            container.innerHTML = '<p>Failed to load students</p>';
            return;
        }
        
        if (data.students.length === 0) {
            container.innerHTML = '<p>No students found.</p>';
            return;
        }
        
        container.innerHTML = data.students.map(student => `
            <div class="user-card">
                <h3>${student.name}</h3>
                <p><strong>Email:</strong> ${student.email}</p>
                <p><strong>Institution:</strong> ${student.institution}</p>
                <p><strong>Cohorts:</strong> ${student.cohort_count || 0}</p>
            </div>
        `).join('');
    } catch (error) {
        showAlert('Failed to load students: ' + error.message, 'error');
    }
}

async function loadTeachersForSelect() {
    try {
        const res = await fetch('/api/admin/teachers', { credentials: 'same-origin' });
        const data = await res.json();
        const select = document.getElementById('cohort-teacher');
        
        if (!data.success) {
            select.innerHTML = '<option value="">Failed to load teachers</option>';
            return;
        }
        
        select.innerHTML = '<option value="">Select a teacher...</option>' +
            data.teachers.map(teacher => 
                `<option value="${teacher.id}">${teacher.name} (${teacher.subject})</option>`
            ).join('');
    } catch (error) {
        showAlert('Failed to load teachers: ' + error.message, 'error');
    }
}

document.getElementById('cohort-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const payload = {
        name: document.getElementById('cohort-name').value.trim(),
        description: document.getElementById('cohort-description').value.trim(),
        subject: document.getElementById('cohort-subject').value.trim(),
        teacher_id: document.getElementById('cohort-teacher').value
    };
    
    try {
        const res = await fetch('/api/admin/cohorts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (data.success) {
            showAlert('Cohort created successfully!', 'success');
            this.reset();
            switchTab('cohorts', null);
            loadCohorts();
        } else {
            showAlert(data.error || 'Failed to create cohort', 'error');
        }
    } catch (error) {
        showAlert('Error creating cohort: ' + error.message, 'error');
    }
});

async function editCohort(cohortId) {
    showAlert('Edit functionality coming soon!', 'success');
}

async function deleteCohort(cohortId) {
    if (!confirm('Are you sure you want to delete this cohort?')) {
        return;
    }
    
    try {
        const res = await fetch(`/api/admin/cohorts/${cohortId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });
        
        const data = await res.json();
        
        if (data.success) {
            showAlert('Cohort deleted successfully!', 'success');
            loadCohorts();
        } else {
            showAlert(data.error || 'Failed to delete cohort', 'error');
        }
    } catch (error) {
        showAlert('Error deleting cohort: ' + error.message, 'error');
    }
}

function showAlert(message, type) {
    const alert = document.getElementById('alert');
    alert.textContent = message;
    alert.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
    alert.style.display = 'block';
    
    setTimeout(() => {
        alert.style.display = 'none';
    }, 5000);
}

async function copyCohortCode(code, elementId) {
    try {
        await navigator.clipboard.writeText(code);
        const button = document.querySelector(`#${elementId}`).nextElementSibling;
        const originalText = button.textContent;
        button.textContent = '✓';
        button.classList.add('copied');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('copied');
        }, 2000);
        
        showAlert('Cohort code copied to clipboard!', 'success');
    } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showAlert('Cohort code copied to clipboard!', 'success');
    }
}

// Load initial data
loadCohorts();

// Cohort Management UI
async function manageCohort(cohortId, name){
    document.getElementById('cohort-manage').style.display = 'block';
    document.getElementById('manage-cohort-title').textContent = `Manage Cohort • ${name}`;
    document.getElementById('current-cohort-id').value = cohortId;
    
    // Get cohort details to display the code
    try {
        const res = await fetch('/api/admin/cohorts', { credentials: 'same-origin' });
        const data = await res.json();
        if (data.success) {
            const cohort = data.cohorts.find(c => c.id === cohortId);
            if (cohort) {
                document.getElementById('current-cohort-code').value = cohort.code;
                document.getElementById('display-cohort-code').textContent = cohort.code;
                document.getElementById('cohort-code-display').style.display = 'block';
                // Update the title to include the cohort code
                document.getElementById('manage-cohort-title').innerHTML = 
                    `Manage Cohort • ${name} <span style="font-size: 0.8em; color: #666;">(Code: ${cohort.code})</span>`;
            }
        }
    } catch (e) {
        console.error('Failed to get cohort details:', e);
    }
    
    await refreshCohortStudents();
    const addBtn = document.getElementById('add-student-btn');
    addBtn.onclick = addStudentToCohort;
    await populateStudentSelect();
}

async function refreshCohortStudents(){
    const cohortId = document.getElementById('current-cohort-id').value;
    if(!cohortId) return;
    try{
        const res = await fetch(`/api/admin/cohort/${cohortId}/students`, { credentials: 'same-origin' });
        const data = await res.json();
        const container = document.getElementById('cohort-students');
        if(!data.success){ container.innerHTML = '<p>Failed to load students</p>'; return; }
        if(data.students.length === 0){ container.innerHTML = '<p>No students in this cohort yet.</p>'; return; }
        container.innerHTML = data.students.map(s => `
            <div class="user-card">
                <h3>${s.name}</h3>
                <p><strong>Email:</strong> ${s.email}</p>
                <p><strong>Institution:</strong> ${s.institution}</p>
                <div class="user-actions">
                    <button class="btn btn-danger" onclick="removeStudent('${s.id}')">Remove</button>
                </div>
            </div>
        `).join('');
    } catch (e){
        showAlert('Failed to load cohort students: ' + e.message, 'error');
    }
}

async function addStudentToCohort(){
    const cohortId = document.getElementById('current-cohort-id').value;
    const select = document.getElementById('add-student-select');
    const selectedId = select.value;
    const email = document.getElementById('add-student-email').value.trim();
    if(!selectedId && !email){ showAlert('Select a student or enter email', 'error'); return; }
    try{
        const res = await fetch(`/api/admin/cohort/${cohortId}/students`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(selectedId ? { student_id: selectedId } : { student_email: email })
        });
        const data = await res.json();
        if(data.success){
            showAlert('Student added to cohort', 'success');
            document.getElementById('add-student-email').value = '';
            select.value = '';
            refreshCohortStudents();
            loadCohorts();
        } else {
            showAlert(data.error || 'Failed to add student', 'error');
        }
    } catch(e){
        showAlert('Failed to add student: ' + e.message, 'error');
    }
}

async function populateStudentSelect(){
    try{
        const res = await fetch('/api/admin/students', { credentials: 'same-origin' });
        const data = await res.json();
        const select = document.getElementById('add-student-select');
        if(!data.success){ select.innerHTML = '<option value="">Failed to load students</option>'; return; }
        select.innerHTML = '<option value="">Select a student...</option>' + data.students.map(s => `<option value="${s.id}">${s.name} (${s.email})</option>`).join('');
    } catch(e){
        // ignore
    }
}

async function removeStudent(studentId){
    const cohortId = document.getElementById('current-cohort-id').value;
    if(!confirm('Remove this student from the cohort?')) return;
    try{
        const res = await fetch(`/api/admin/cohort/${cohortId}/students/${studentId}`, { method: 'DELETE', credentials: 'same-origin' });
        const data = await res.json();
        if(data.success){
            showAlert('Removed student from cohort', 'success');
            refreshCohortStudents();
            loadCohorts();
        } else {
            showAlert(data.error || 'Failed to remove student', 'error');
        }
    } catch (e){
        showAlert('Failed to remove student: ' + e.message, 'error');
    }
}

async function viewCohortLectures(cohortId, name){
    document.getElementById('cohortLectures').style.display = 'block';
    const container = document.getElementById('cohort-lectures-list');
    container.innerHTML = '<p>Loading...</p>';
    try{
        const res = await fetch(`/api/admin/cohort/${cohortId}/lectures`, { credentials: 'same-origin' });
        const data = await res.json();
        if(!data.success){ container.innerHTML = '<p>Failed to load cohort lectures</p>'; return; }
        if(data.lectures.length === 0){ container.innerHTML = '<p>No lectures in this cohort yet.</p>'; return; }
        container.innerHTML = data.lectures.map(lecture => `
            <div class="cohort-card">
                <h3>${lecture.title}</h3>
                <p>${lecture.description || 'No description'}</p>
                <p><strong>Scheduled:</strong> ${new Date(lecture.scheduled_time).toLocaleString()}</p>
                <p><strong>Teacher:</strong> ${lecture.teacher_name || 'Unknown'}</p>
                <span class="status-badge ${lecture.session_active ? 'status-active' : 'status-scheduled'}">
                    ${lecture.session_active ? 'Live Now' : 'Scheduled'}
                </span>
            </div>
        `).join('');
    } catch(e){
        container.innerHTML = '<p>Failed to load cohort lectures</p>';
    }
}

async function viewCohortPolls(cohortId, name){
    // Set the current cohort ID for poll creation
    document.getElementById('current-cohort-id').value = cohortId;
    
    document.getElementById('cohortPolls').style.display = 'block';
    const container = document.getElementById('cohort-polls-list');
    container.innerHTML = '<p>Loading...</p>';
    try{
        const res = await fetch(`/api/cohorts/${cohortId}/polls`, { credentials: 'same-origin' });
        const data = await res.json();
        if(!data.success){ container.innerHTML = '<p>Failed to load cohort polls</p>'; return; }
        if(data.polls.length === 0){ container.innerHTML = '<p>No polls in this cohort yet.</p>'; return; }
        container.innerHTML = data.polls.map(poll => `
            <div class="cohort-card">
                <h3>${poll.question}</h3>
                <p><strong>Options:</strong> ${poll.options.join(', ')}</p>
                <p><strong>Created:</strong> ${new Date(poll.created_at).toLocaleString()}</p>
                <div class="cohort-actions">
                    <button class="btn" onclick="viewPollResults('${poll.id}')">View Results</button>
                </div>
            </div>
        `).join('');
    } catch(e){
        container.innerHTML = '<p>Failed to load cohort polls</p>';
    }
}

function showCreateCohortPollModal(){
    const cohortId = document.getElementById('current-cohort-id').value;
    if(!cohortId){
        showAlert('Please select a cohort first', 'error');
        return;
    }
    
    // Reset form
    document.getElementById('pollQuestion').value = '';
    const optionsContainer = document.getElementById('pollOptions');
    optionsContainer.innerHTML = `
        <div class="option-row">
            <input type="text" placeholder="Option 1" class="poll-option-input">
            <button class="btn-remove" onclick="removePollOption(this)">×</button>
        </div>
        <div class="option-row">
            <input type="text" placeholder="Option 2" class="poll-option-input">
            <button class="btn-remove" onclick="removePollOption(this)">×</button>
        </div>
    `;
    
    // Show modal
    document.getElementById('pollModal').style.display = 'flex';
}

function closePollModal(){
    document.getElementById('pollModal').style.display = 'none';
}

function addPollOption(){
    const optionsContainer = document.getElementById('pollOptions');
    const optionCount = optionsContainer.children.length + 1;
    
    const optionDiv = document.createElement('div');
    optionDiv.className = 'option-row';
    optionDiv.innerHTML = `
        <input type="text" placeholder="Option ${optionCount}" class="poll-option-input">
        <button class="btn-remove" onclick="removePollOption(this)">×</button>
    `;
    
    optionsContainer.appendChild(optionDiv);
}

function removePollOption(button){
    const optionRow = button.parentElement;
    if(optionRow.parentElement.children.length > 2){
        optionRow.remove();
    }
}

function createCohortPollFromModal(){
    const cohortId = document.getElementById('current-cohort-id').value;
    const question = document.getElementById('pollQuestion').value.trim();
    const optionInputs = document.querySelectorAll('.poll-option-input');
    const options = Array.from(optionInputs)
        .map(input => input.value.trim())
        .filter(option => option.length > 0);
    
    if(!question){
        showAlert('Please enter a poll question', 'error');
        return;
    }
    
    if(options.length < 2){
        showAlert('Please enter at least 2 options', 'error');
        return;
    }
    
    createCohortPoll(cohortId, question, options);
    closePollModal();
}

async function createCohortPoll(cohortId, question, options){
    try{
        const res = await fetch(`/api/cohorts/${cohortId}/polls`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ question, options })
        });
        
        const data = await res.json();
        if(data.success){
            showAlert('Poll created successfully!', 'success');
            viewCohortPolls(cohortId, '');
        } else {
            showAlert(data.error || 'Failed to create poll', 'error');
        }
    } catch(e){
        showAlert('Failed to create poll: ' + e.message, 'error');
    }
}

// Teacher Management Functions
function showCreateTeacherModal() {
    document.getElementById('createTeacherModal').style.display = 'flex';
    document.getElementById('create-teacher-form').reset();
}

function closeCreateTeacherModal() {
    document.getElementById('createTeacherModal').style.display = 'none';
}

async function createTeacher() {
    const name = document.getElementById('teacher-name').value.trim();
    const email = document.getElementById('teacher-email').value.trim();
    const institution = document.getElementById('teacher-institution').value.trim();
    const subject = document.getElementById('teacher-subject').value.trim();
    const password = document.getElementById('teacher-password').value;

    if (!name || !email || !institution || !subject || !password) {
        showAlert('Please fill in all fields', 'error');
        return;
    }

    try {
        const res = await fetch('/api/register/teacher', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ name, email, institution, subject, password })
        });
        
        const data = await res.json();
        if (data.success) {
            showAlert('Teacher created successfully!', 'success');
            closeCreateTeacherModal();
            loadTeachers();
        } else {
            showAlert(data.error || 'Failed to create teacher', 'error');
        }
    } catch (error) {
        showAlert('Failed to create teacher: ' + error.message, 'error');
    }
}

// Student Management Functions
function showCreateStudentModal() {
    document.getElementById('createStudentModal').style.display = 'flex';
    document.getElementById('create-student-form').reset();
}

function closeCreateStudentModal() {
    document.getElementById('createStudentModal').style.display = 'none';
}

async function createStudent() {
    const name = document.getElementById('student-name').value.trim();
    const email = document.getElementById('student-email').value.trim();
    const institution = document.getElementById('student-institution').value.trim();
    const password = document.getElementById('student-password').value;

    if (!name || !email || !institution || !password) {
        showAlert('Please fill in all fields', 'error');
        return;
    }

    try {
        const res = await fetch('/api/register/student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ name, email, institution, password })
        });
        
        const data = await res.json();
        if (data.success) {
            showAlert('Student created successfully!', 'success');
            closeCreateStudentModal();
            loadStudents();
        } else {
            showAlert(data.error || 'Failed to create student', 'error');
        }
    } catch (error) {
        showAlert('Failed to create student: ' + error.message, 'error');
    }
}

async function viewPollResults(pollId){
    try{
        const res = await fetch(`/api/polls/${pollId}/results`, { credentials: 'same-origin' });
        const data = await res.json();
        if(data.success){
            const results = data.results;
            let resultsHTML = `
                <h3>${results.question}</h3>
                <p><strong>Total Votes:</strong> ${results.total_votes}</p>
                <div style="margin-top: 1rem;">
            `;
            
            results.results.forEach(result => {
                resultsHTML += `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>${result.option}</span>
                            <span>${result.votes} votes (${result.percentage}%)</span>
                        </div>
                        <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: ${result.percentage}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold;">
                                ${result.percentage}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += '</div>';
            
            // Show results in a modal or alert
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;">
                    ${resultsHTML}
                    <button class="btn" onclick="this.parentElement.parentElement.remove()" style="margin-top: 1rem;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        } else {
            showAlert(data.error || 'Failed to load poll results', 'error');
        }
    } catch(e){
        showAlert('Failed to load poll results: ' + e.message, 'error');
    }
}
</script>
{% endblock %}
