{% extends 'base.html' %}
{% block title %}Student Dashboard â€¢ Digi Kul{% endblock %}
{% block header_title %}Student Dashboard{% endblock %}

{% block content %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<div class="container-fluid py-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Student Dashboard</h1>
                    <p class="text-muted">Welcome back, {{ session.get('user_name') }}!</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="showJoinCohortModal()">
                        <i class="bi bi-people me-2"></i>Join Cohort
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check fs-1 mb-3"></i>
                    <h3 class="mb-1" id="totalLectures">0</h3>
                    <p class="mb-0">Available Lectures</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="bi bi-people-fill fs-1 mb-3"></i>
                    <h3 class="mb-1" id="totalCohorts">0</h3>
                    <p class="mb-0">My Cohorts</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="bi bi-question-circle-fill fs-1 mb-3"></i>
                    <h3 class="mb-1" id="totalQuizzes">0</h3>
                    <p class="mb-0">Available Quizzes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-text fs-1 mb-3"></i>
                    <h3 class="mb-1" id="totalMaterials">0</h3>
                    <p class="mb-0">Materials</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="lectures-tab" data-bs-toggle="tab" data-bs-target="#lectures" type="button" role="tab">
                        <i class="bi bi-calendar-event me-2"></i>Available Lectures
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="quizzes-tab" data-bs-toggle="tab" data-bs-target="#quizzes" type="button" role="tab">
                        <i class="bi bi-question-circle me-2"></i>Quizzes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button" role="tab">
                        <i class="bi bi-file-earmark-text me-2"></i>Materials
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cohorts-tab" data-bs-toggle="tab" data-bs-target="#cohorts" type="button" role="tab">
                        <i class="bi bi-people me-2"></i>My Cohorts
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="dashboardTabsContent">
                <!-- Lectures Tab -->
                <div class="tab-pane fade show active" id="lectures" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0">Available Lectures</h5>
                        </div>
                        <div class="card-body">
                            <div id="lecturesList" class="row">
                                <div class="col-12 text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading lectures...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quizzes Tab -->
                <div class="tab-pane fade" id="quizzes" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0">Available Quizzes</h5>
                        </div>
                        <div class="card-body">
                            <div id="quizzesList" class="row">
                                <div class="col-12 text-center py-5">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading quizzes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Materials Tab -->
                <div class="tab-pane fade" id="materials" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0">Learning Materials</h5>
                        </div>
                        <div class="card-body">
                            <div id="materialsList" class="row">
                                <div class="col-12 text-center py-5">
                                    <div class="spinner-border text-info" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading materials...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cohorts Tab -->
                <div class="tab-pane fade" id="cohorts" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">My Cohorts</h5>
                            <button class="btn btn-primary btn-sm" onclick="showJoinCohortModal()">
                                <i class="bi bi-plus-circle me-1"></i>Join Cohort
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="cohortsList" class="row">
                                <div class="col-12 text-center py-5">
                                    <div class="spinner-border text-warning" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading cohorts...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Join Cohort Modal -->
<div class="modal fade" id="joinCohortModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Join a Cohort</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="joinCohortForm">
                    <div class="mb-3">
                        <label for="cohortCode" class="form-label">Cohort Code</label>
                        <input type="text" class="form-control" id="cohortCode" placeholder="Enter cohort code" required>
                        <div class="form-text">Ask your teacher for the cohort code to join</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="joinCohort()">Join Cohort</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Global variables
let lectures = [];
let quizzes = [];
let materials = [];
let cohorts = [];

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadStudentData();
});

// Load student data
async function loadStudentData() {
    try {
        await loadLectures();
        await loadQuizzes();
        await loadMaterials();
        await loadCohorts();
        updateStats();
    } catch (error) {
        console.error('Error loading student data:', error);
        showToast('Failed to load dashboard data', 'error');
    }
}

// Load lectures
async function loadLectures() {
    try {
        const response = await fetch('/api/lectures/student');
        const data = await response.json();
        
        if (data.success) {
            lectures = data.lectures;
            displayLectures(lectures);
        }
    } catch (error) {
        console.error('Error loading lectures:', error);
    }
}

// Display lectures
function displayLectures(lecturesList) {
    const container = document.getElementById('lecturesList');
    
    if (lecturesList.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">No lectures available</h5>
                <p class="text-muted">Join a cohort to see available lectures</p>
                <button class="btn btn-primary" onclick="showJoinCohortModal()">
                    <i class="bi bi-people me-2"></i>Join Cohort
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = lecturesList.map(lecture => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card lecture-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">${lecture.title}</h6>
                        <span class="badge ${getLectureStatusBadge(lecture)}">${getLectureStatus(lecture)}</span>
                    </div>
                    <p class="card-text text-muted small">${lecture.description || 'No description'}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            ${new Date(lecture.scheduled_time).toLocaleDateString()}
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            ${lecture.duration} min
                        </small>
                    </div>
                    <div class="mt-3 d-flex gap-2">
                        ${getLectureActions(lecture)}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Get lecture status
function getLectureStatus(lecture) {
    const now = new Date();
    const scheduled = new Date(lecture.scheduled_time);
    const endTime = new Date(scheduled.getTime() + lecture.duration * 60000);
    
    if (now < scheduled) return 'Scheduled';
    if (now >= scheduled && now <= endTime) return 'Live Now';
    return 'Expired';
}

// Get lecture status badge class
function getLectureStatusBadge(lecture) {
    const status = getLectureStatus(lecture);
    switch (status) {
        case 'Live Now': return 'bg-success';
        case 'Scheduled': return 'bg-warning';
        case 'Expired': return 'bg-secondary';
        default: return 'bg-primary';
    }
}

// Get lecture actions
function getLectureActions(lecture) {
    const status = getLectureStatus(lecture);
    let actions = '';
    
    if (status === 'Live Now') {
        actions += `<button class="btn btn-success btn-sm" onclick="joinLiveSession('${lecture.id}')">
            <i class="bi bi-play-circle me-1"></i>Join Live
        </button>`;
    }
    
    actions += `<button class="btn btn-outline-primary btn-sm" onclick="viewLectureMaterials('${lecture.id}')">
        <i class="bi bi-file-earmark me-1"></i>Materials
    </button>`;
    
    return actions;
}

// Load quizzes
async function loadQuizzes() {
    try {
        const response = await fetch('/api/quiz/student/available');
        const data = await response.json();
        
        if (data.success) {
            quizzes = data.quiz_sets;
            displayQuizzes(quizzes);
        }
    } catch (error) {
        console.error('Error loading quizzes:', error);
    }
}

// Display quizzes
function displayQuizzes(quizzesList) {
    const container = document.getElementById('quizzesList');
    
    if (quizzesList.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-question-circle text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">No quizzes available</h5>
                <p class="text-muted">Join a cohort to see available quizzes</p>
                <button class="btn btn-primary" onclick="showJoinCohortModal()">
                    <i class="bi bi-people me-2"></i>Join Cohort
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = quizzesList.map(quiz => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card quiz-card">
                <div class="card-body">
                    <h6 class="card-title">${quiz.title}</h6>
                    <p class="card-text text-muted small">${quiz.description || 'No description'}</p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <small class="text-muted">
                            <i class="bi bi-question-circle me-1"></i>
                            ${quiz.question_count || 0} questions
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            ${quiz.time_limit ? quiz.time_limit + ' min' : 'No limit'}
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" onclick="startQuiz('${quiz.id}')">
                            <i class="bi bi-play-circle me-1"></i>Start Quiz
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="viewQuizHistory('${quiz.id}')">
                            <i class="bi bi-clock-history me-1"></i>History
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Load materials
async function loadMaterials() {
    try {
        const response = await fetch('/api/materials/student');
        const data = await response.json();
        
        if (data.success) {
            materials = data.materials;
            displayMaterials(materials);
        }
    } catch (error) {
        console.error('Error loading materials:', error);
    }
}

// Display materials
function displayMaterials(materialsList) {
    const container = document.getElementById('materialsList');
    
    if (materialsList.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-file-earmark-x text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">No materials available</h5>
                <p class="text-muted">Join a cohort to access learning materials</p>
                <button class="btn btn-primary" onclick="showJoinCohortModal()">
                    <i class="bi bi-people me-2"></i>Join Cohort
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = materialsList.map(material => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card material-card">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-2">
                        <i class="bi ${getFileIcon(material.file_type)} text-primary fs-4 me-3"></i>
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${material.title}</h6>
                            <p class="card-text text-muted small">${material.description || 'No description'}</p>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            ${new Date(material.uploaded_at).toLocaleDateString()}
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-download me-1"></i>
                            ${formatFileSize(material.file_size)}
                        </small>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-sm" onclick="downloadMaterial('${material.id}')">
                            <i class="bi bi-download me-1"></i>Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Load cohorts
async function loadCohorts() {
    try {
        const response = await fetch('/api/cohorts/student');
        const data = await response.json();
        
        if (data.success) {
            cohorts = data.cohorts;
            displayCohorts(cohorts);
        }
    } catch (error) {
        console.error('Error loading cohorts:', error);
    }
}

// Display cohorts
function displayCohorts(cohortsList) {
    const container = document.getElementById('cohortsList');
    
    if (cohortsList.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">No cohorts joined</h5>
                <p class="text-muted">Join a cohort to access lectures, quizzes, and materials</p>
                <button class="btn btn-primary" onclick="showJoinCohortModal()">
                    <i class="bi bi-people me-2"></i>Join Cohort
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = cohortsList.map(cohort => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card cohort-card">
                <div class="card-body">
                    <h6 class="card-title">${cohort.name}</h6>
                    <p class="card-text text-muted small">${cohort.description || 'No description'}</p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <small class="text-muted">
                            <i class="bi bi-book me-1"></i>
                            ${cohort.subject}
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-people me-1"></i>
                            ${cohort.student_count || 0} students
                        </small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            Joined ${new Date(cohort.joined_at).toLocaleDateString()}
                        </small>
                        <span class="badge bg-success">Active</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Update dashboard stats
function updateStats() {
    document.getElementById('totalLectures').textContent = lectures.length;
    document.getElementById('totalCohorts').textContent = cohorts.length;
    document.getElementById('totalQuizzes').textContent = quizzes.length;
    document.getElementById('totalMaterials').textContent = materials.length;
}

// Modal functions
function showJoinCohortModal() {
    const modal = new bootstrap.Modal(document.getElementById('joinCohortModal'));
    modal.show();
}

// Join cohort
async function joinCohort() {
    const code = document.getElementById('cohortCode').value.trim();
    
    if (!code) {
        showToast('Please enter a cohort code', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/cohorts/student/join', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('joinCohortModal')).hide();
            document.getElementById('joinCohortForm').reset();
            loadStudentData(); // Reload all data
        } else {
            showToast(data.error || 'Failed to join cohort', 'error');
        }
    } catch (error) {
        console.error('Error joining cohort:', error);
        showToast('Failed to join cohort', 'error');
    }
}

// Utility functions
function getFileIcon(fileType) {
    switch (fileType) {
        case 'pdf': return 'bi-file-earmark-pdf';
        case 'doc': case 'docx': return 'bi-file-earmark-word';
        case 'ppt': case 'pptx': return 'bi-file-earmark-ppt';
        case 'jpg': case 'jpeg': case 'png': case 'gif': return 'bi-file-earmark-image';
        case 'mp3': case 'wav': return 'bi-file-earmark-music';
        case 'mp4': case 'avi': return 'bi-file-earmark-play';
        default: return 'bi-file-earmark';
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Placeholder functions for actions
function joinLiveSession(lectureId) {
    showToast('Joining live session...', 'info');
}

function viewLectureMaterials(lectureId) {
    showToast('Viewing lecture materials...', 'info');
}

function startQuiz(quizId) {
    showToast('Starting quiz...', 'info');
}

function viewQuizHistory(quizId) {
    showToast('Viewing quiz history...', 'info');
}

function downloadMaterial(materialId) {
    window.open(`/api/download/${materialId}`, '_blank');
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    container.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}