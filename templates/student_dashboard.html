{% extends 'base.html' %}
{% block title %}Student Dashboard ‚Ä¢ Digi Kul{% endblock %}
{% block header_title %}Student Dashboard{% endblock %}
{% block content %}
<div class="tabs">
    <button class="tab active" onclick="switchTab('cohorts', event)">üè´ My Cohorts</button>
    <button class="tab" onclick="switchTab('available', event)">üìö Available Lectures</button>
    <button class="tab" onclick="switchTab('enrolled', event)">üìñ Enrolled Lectures</button>
    <button class="tab" onclick="switchTab('polls', event)">üìä Polls</button>
</div>

<!-- Cohorts Tab -->
<div id="cohorts" class="tab-content active">
    <div class="card-header">
        <h2 class="card-title">My Cohorts</h2>
        <p class="card-subtitle">Join cohorts to access lectures and materials</p>
    </div>
    <div id="cohorts-list"></div>
</div>

<!-- Available Lectures Tab -->
<div id="available" class="tab-content">
    <div class="card-header">
        <h2 class="card-title">Available Lectures</h2>
        <p class="card-subtitle">Browse and enroll in available lectures</p>
    </div>
    <div id="available-list"></div>
</div>

<!-- Enrolled Lectures Tab -->
<div id="enrolled" class="tab-content">
    <div class="card-header">
        <h2 class="card-title">Your Enrollments</h2>
        <p class="card-subtitle">Manage your enrolled lectures</p>
    </div>
    <div id="enrolled-list"></div>
</div>

<!-- Polls Tab -->
<div id="polls" class="tab-content">
    <div class="card-header">
        <h2 class="card-title">Available Polls</h2>
        <p class="card-subtitle">Participate in polls from your cohorts</p>
    </div>
    <div id="polls-list"></div>
</div>

<div id="alert" class="alert"></div>

<!-- Custom styles for student dashboard specific elements -->
<style>
.lecture-card, .cohort-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-4);
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
}

.lecture-card:hover, .cohort-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.lecture-card h3, .cohort-card h3 {
    color: var(--gray-900);
    margin-bottom: var(--space-2);
    font-size: var(--font-size-lg);
    font-weight: 600;
}

.lecture-card p, .cohort-card p {
    color: var(--gray-600);
    margin-bottom: var(--space-4);
    font-size: var(--font-size-sm);
}

.lecture-actions, .cohort-actions {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.status-badge {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-xl);
    font-size: var(--font-size-xs);
    font-weight: 600;
    margin-bottom: var(--space-4);
}

.status-active {
    background: #f0fdf4;
    color: #16a34a;
    border: 1px solid #bbf7d0;
}

.status-scheduled {
    background: #fffbeb;
    color: #d97706;
    border: 1px solid #fed7aa;
}

.option-row {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
    align-items: center;
}

.poll-option-input {
    flex: 1;
}

.btn-remove {
    background: var(--error);
    color: var(--white);
    border: none;
    border-radius: 50%;
    width: 2rem;
    height: 2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-lg);
    transition: all 0.3s ease;
}

.btn-remove:hover {
    background: #dc2626;
    transform: scale(1.1);
}

.btn-add {
    background: var(--success);
    color: var(--white);
    border: none;
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-add:hover {
    background: #059669;
    transform: translateY(-1px);
}

.btn-copy {
    background: var(--info);
    color: var(--white);
    border: none;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-sm);
    cursor: pointer;
    margin-left: var(--space-3);
    font-size: var(--font-size-xs);
    transition: all 0.3s ease;
}

.btn-copy:hover {
    background: #2563eb;
    transform: scale(1.05);
}

@media (max-width: 768px) {
    .lecture-actions, .cohort-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<script>
function switchTab(tabName, event) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked tab
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Load content based on tab
    if (tabName === 'cohorts') {
        loadCohorts();
    } else if (tabName === 'available') {
        loadAvailable();
    } else if (tabName === 'enrolled') {
        loadEnrolled();
    } else if (tabName === 'polls') {
        loadPolls();
    }
}

async function loadCohorts() {
    try {
        const res = await fetch('/api/student/cohorts', { credentials: 'same-origin' });
        const data = await res.json();
        const container = document.getElementById('cohorts-list');
        
        if (!data.success) {
            container.innerHTML = '<p>Failed to load cohorts</p>';
            return;
        }
        
        if (data.cohorts.length === 0) {
            container.innerHTML = `
                <p>You are not part of any cohorts yet. Join a cohort to access lectures!</p>
                <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <h4>Join a Cohort</h4>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="text" id="cohortCode" placeholder="Enter cohort code" style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                        <button class="btn" onclick="joinCohort()">Join</button>
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = data.cohorts.map(cohort => `
            <div class="cohort-card">
                <h3>${cohort.name}</h3>
                <p>${cohort.description || 'No description'}</p>
                <p><strong>Subject:</strong> ${cohort.subject}</p>
                <p><strong>Teacher:</strong> ${cohort.teacher_name}</p>
                <div class="cohort-actions">
                    <a href="#" onclick="viewCohortLectures('${cohort.id}'); return false;" class="btn">View Lectures</a>
                </div>
            </div>
        `).join('');
    } catch (error) {
        showAlert('Failed to load cohorts: ' + error.message, 'error');
    }
}

async function loadAvailable() {
    try {
        const res = await fetch('/api/student/lectures/available', { credentials: 'same-origin' });
        const data = await res.json();
        const container = document.getElementById('available-list');
        
        if (!data.success) {
            container.innerHTML = '<p>Failed to load lectures</p>';
            return;
        }
        
        if (data.lectures.length === 0) {
            container.innerHTML = '<p>No lectures available.</p>';
            return;
        }
        
        container.innerHTML = data.lectures.map(lecture => `
            <div class="lecture-card">
                <span class="status-badge ${lecture.session_active ? 'status-active' : 'status-scheduled'}">
                    ${lecture.session_active ? 'Live Now' : 'Scheduled'}
                </span>
                <h3>${lecture.title}</h3>
                <p>${lecture.description || 'No description'}</p>
                <p><strong>Teacher:</strong> ${lecture.teacher_name || 'Unknown'}</p>
                <p><strong>Scheduled:</strong> ${new Date(lecture.scheduled_time).toLocaleString()}</p>
                <div class="lecture-actions">
                    <button class="btn" onclick="enroll('${lecture.id}')">Enroll</button>
                    ${lecture.session_active ? `<button class="btn btn-success" onclick="joinLive('${lecture.id}')">üî¥ Join Live</button>` : ''}
                </div>
            </div>
        `).join('');
    } catch (error) {
        showAlert('Failed to load available lectures: ' + error.message, 'error');
    }
}

async function loadEnrolled() {
    try {
        const res = await fetch('/api/student/enrolled_lectures', { credentials: 'same-origin' });
        const data = await res.json();
        const container = document.getElementById('enrolled-list');
        
        if (!data.success) {
            container.innerHTML = '<p>Failed to load enrolled lectures</p>';
            return;
        }
        
        if (data.lectures.length === 0) {
            container.innerHTML = '<p>You are not enrolled in any lectures yet.</p>';
            return;
        }
        
        container.innerHTML = data.lectures.map(lecture => `
            <div class="lecture-card">
                <span class="status-badge ${lecture.session_active ? 'status-active' : 'status-scheduled'}">
                    ${lecture.session_active ? 'Live Now' : 'Scheduled'}
                </span>
                <h3>${lecture.title}</h3>
                <p>${lecture.description || 'No description'}</p>
                <p><strong>Teacher:</strong> ${lecture.teacher_name || 'Unknown'}</p>
                <p><strong>Scheduled:</strong> ${new Date(lecture.scheduled_time).toLocaleString()}</p>
                <div class="lecture-actions">
                    ${lecture.session_active ? `<button class="btn btn-success" onclick="joinLive('${lecture.id}')">üî¥ Join Live</button>` : ''}
                    <button class="btn btn-secondary" onclick="viewMaterials('${lecture.id}')">üìÅ Materials</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        showAlert('Failed to load enrolled lectures: ' + error.message, 'error');
    }
}

async function enroll(lectureId) {
    try {
        const res = await fetch('/api/student/enroll', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ lecture_id: lectureId })
        });
        const data = await res.json();
        
        if (data.success) {
            if (data.already_enrolled) {
                showAlert('You are already enrolled in this lecture!', 'success');
            } else {
                showAlert('Successfully enrolled in lecture!', 'success');
            }
            loadEnrolled();
            // Reload current tab to update the UI
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabName = activeTab.textContent.includes('Cohorts') ? 'cohorts' : 
                               activeTab.textContent.includes('Available') ? 'available' : 'enrolled';
                switchTab(tabName);
            }
        } else {
            showAlert(data.error || 'Enrollment failed', 'error');
        }
    } catch (error) {
        showAlert('Error enrolling: ' + error.message, 'error');
    }
}

async function joinLive(lectureId) {
    try {
        const res = await fetch(`/api/session/by_lecture/${lectureId}`, { credentials: 'same-origin' });
        const data = await res.json();
        if (data.success && data.session_id) {
            window.location.href = `/student/join_session/${data.session_id}`;
        } else {
            showAlert(data.error || 'No active session yet', 'error');
        }
    } catch (error) {
        showAlert('Unable to resolve live session: ' + error.message, 'error');
    }
}

async function viewMaterials(lectureId) {
    try {
        const res = await fetch(`/api/student/lecture/${lectureId}/materials`, { credentials: 'same-origin' });
        const data = await res.json();
        
        if (!data.success) {
            showAlert(data.error || 'Failed to load materials', 'error');
            return;
        }
        
        showMaterialsModal(data.materials || []);
    } catch (error) {
        showAlert('Error loading materials: ' + error.message, 'error');
    }
}

function showMaterialsModal(materials) {
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.style.zIndex = '1000';
    
    const materialsHTML = materials.length === 0 
        ? '<p style="text-align: center; color: #666; padding: 20px;">No materials available for this lecture</p>'
        : materials.map(material => `
            <div class="material-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin: 10px 0; background: #f8f9fa;">
                <div class="material-info" style="flex: 1;">
                    <h4 style="margin: 0 0 5px 0; color: #333; font-size: 16px;">${material.title}</h4>
                    <p style="margin: 0 0 5px 0; color: #666; font-size: 14px;">${material.description || 'No description'}</p>
                    <p style="margin: 0; color: #999; font-size: 12px;">
                        ${material.file_type} ‚Ä¢ ${(material.file_size / (1024 * 1024)).toFixed(2)} MB ‚Ä¢ 
                        Uploaded: ${new Date(material.uploaded_at).toLocaleDateString()}
                    </p>
                </div>
                <div class="material-actions">
                    <a href="/api/download/${material.id}" class="btn" style="padding: 8px 16px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">üì• Download</a>
                </div>
            </div>
        `).join('');
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #ddd;">
                <h3 style="margin: 0; color: #333;">Lecture Materials</h3>
                <span class="close" onclick="this.closest('.modal').remove()" style="font-size: 24px; cursor: pointer; color: #999;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                ${materialsHTML}
            </div>
            <div class="modal-footer" style="padding: 20px; border-top: 1px solid #ddd; text-align: right;">
                <button onclick="this.closest('.modal').remove()" class="btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
        </div>
    `;
    
    // Add modal styles
    const style = document.createElement('style');
    style.textContent = `
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
        }
        .close:hover {
            color: #333 !important;
        }
        .material-item:hover {
            background: #e9ecef !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

async function viewCohortLectures(cohortId) {
    try {
        const res = await fetch(`/api/student/cohort/${cohortId}/lectures`, { credentials: 'same-origin' });
        const data = await res.json();
        
        if (!data.success) {
            showAlert(data.error || 'Failed to load cohort lectures', 'error');
            return;
        }
        
        if (!data.lectures || data.lectures.length === 0) {
            showAlert('No lectures available in this cohort', 'success');
            return;
        }
        
        // Render in Available tab with just this cohort's lectures
        switchTab('available');
        const container = document.getElementById('available-list');
        container.innerHTML = data.lectures.map(lecture => `
            <div class="lecture-card">
                <span class="status-badge ${lecture.session_active ? 'status-active' : 'status-scheduled'}">
                    ${lecture.session_active ? 'Live Now' : 'Scheduled'}
                </span>
                <h3>${lecture.title}</h3>
                <p>${lecture.description || 'No description'}</p>
                <p><strong>Teacher:</strong> ${lecture.teacher_name || 'Unknown'}</p>
                <p><strong>Scheduled:</strong> ${new Date(lecture.scheduled_time).toLocaleString()}</p>
                <div class="lecture-actions">
                    <button class="btn" onclick="enroll('${lecture.id}')">Enroll</button>
                    ${lecture.session_active ? `<button class="btn btn-success" onclick="joinLive('${lecture.id}')">üî¥ Join Live</button>` : ''}
                    <button class="btn btn-secondary" onclick="viewMaterials('${lecture.id}')">üìÅ Materials</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading cohort lectures:', error);
        showAlert('Error loading cohort lectures: ' + error.message, 'error');
    }
}

async function joinCohort() {
    const cohortCode = document.getElementById('cohortCode').value.trim();
    if (!cohortCode) {
        showAlert('Please enter a cohort code', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/student/cohorts/join', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ cohort_code: cohortCode })
        });
        const data = await res.json();
        
        if (data.success) {
            showAlert('Successfully joined cohort!', 'success');
            document.getElementById('cohortCode').value = '';
            loadCohorts();
        } else {
            showAlert(data.error || 'Failed to join cohort', 'error');
        }
    } catch (error) {
        showAlert('Error joining cohort: ' + error.message, 'error');
    }
}

async function loadPolls() {
    try {
        const res = await fetch('/api/student/polls', { credentials: 'same-origin' });
        const data = await res.json();
        const container = document.getElementById('polls-list');
        
        if (!data.success) {
            container.innerHTML = '<p>Failed to load polls</p>';
            return;
        }
        
        if (data.polls.length === 0) {
            container.innerHTML = '<p>No polls available at the moment.</p>';
            return;
        }
        
        container.innerHTML = data.polls.map(poll => `
            <div class="lecture-card">
                <h3>${poll.question}</h3>
                <p><strong>Options:</strong> ${poll.options.join(', ')}</p>
                <p><strong>Created:</strong> ${new Date(poll.created_at).toLocaleString()}</p>
                <div class="lecture-actions">
                    <button class="btn" onclick="votePoll('${poll.id}')">Vote</button>
                    <button class="btn btn-secondary" onclick="viewPollResults('${poll.id}')">View Results</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load polls:', error);
        document.getElementById('polls-list').innerHTML = '<p>Failed to load polls</p>';
    }
}

async function votePoll(pollId) {
    try {
        // Get poll details first
        const pollRes = await fetch(`/api/polls/${pollId}/results`, { credentials: 'same-origin' });
        const pollData = await pollRes.json();
        
        if (!pollData.success) {
            showAlert('Failed to load poll details', 'error');
            return;
        }
        
        const poll = pollData.poll;
        const options = poll.options;
        
        // Create voting modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>${poll.question}</h3>
                    <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Select your answer:</p>
                    <form id="voteForm">
                        ${options.map((option, index) => `
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="vote" value="${option}" required>
                                ${option}
                            </label>
                        `).join('')}
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn">Submit Vote</button>
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Handle form submission
        document.getElementById('voteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const selectedOption = formData.get('vote');
            
            if (!selectedOption) {
                showAlert('Please select an option', 'error');
                return;
            }
            
            try {
                const res = await fetch(`/api/polls/${pollId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ response: selectedOption })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showAlert('Vote submitted successfully!', 'success');
                    modal.remove();
                    loadPolls(); // Refresh polls list
                } else {
                    showAlert(data.error || 'Failed to submit vote', 'error');
                }
            } catch (error) {
                showAlert('Error submitting vote: ' + error.message, 'error');
            }
        });
        
    } catch (error) {
        showAlert('Error loading poll: ' + error.message, 'error');
    }
}

async function viewPollResults(pollId) {
    try {
        const res = await fetch(`/api/polls/${pollId}/results`, { credentials: 'same-origin' });
        const data = await res.json();
        
        if (!data.success) {
            showAlert('Failed to load poll results', 'error');
            return;
        }
        
        const poll = data.poll;
        
        // Create results modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Poll Results: ${poll.question}</h3>
                    <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                </div>
                <div class="modal-body">
                    <p><strong>Total Votes:</strong> ${poll.total_votes}</p>
                    <div style="margin-top: 20px;">
                        ${poll.results.map(result => `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${result.option}</span>
                                    <span><strong>${result.votes} votes (${result.percentage}%)</strong></span>
                                </div>
                                <div style="width: 100%; background-color: #f0f0f0; border-radius: 3px; margin-top: 5px;">
                                    <div style="width: ${result.percentage}%; background-color: #007bff; height: 20px; border-radius: 3px;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        showAlert('Error loading poll results: ' + error.message, 'error');
    }
}

function showAlert(message, type) {
    const alert = document.getElementById('alert');
    alert.textContent = message;
    alert.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
    alert.style.display = 'block';
    
    setTimeout(() => {
        alert.style.display = 'none';
    }, 5000);
}

// Load initial data
loadCohorts();
</script>
{% endblock %}



